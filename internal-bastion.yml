---
description: Travis CI Internal bastion template
variables:
  aws_access_key: "{{ env `AWS_ACCESS_KEY` }}"
  aws_secret_key: "{{ env `AWS_SECRET_KEY` }}"
  duo_api_hostname: "{{ env `DUO_API_HOSTNAME` }}"
  duo_integration_key: "{{ env `DUO_INTEGRATION_KEY` }}"
  duo_secret_key: "{{ env `DUO_SECRET_KEY` }}"
  gce_account_file: "{{ env `GCE_ACCOUNT_FILE` }}"
  gce_project_id: "{{ env `GCE_PROJECT_ID` }}"
  github_oauth_token: "{{ env `GITHUB_OAUTH_TOKEN` }}"
  papertrail_remote_port: "{{ env `PAPERTRAIL_REMOTE_PORT` }}"
  subnet_id: "{{ env `BASTION_SUBNET_ID` }}"
  ubuntu_trusty_ami: "{{ env `UBUNTU_TRUSTY_AMI` }}"
  vpc_id: "{{ env `BASTION_VPC_ID` }}"
builders:
- type: amazon-ebs
  access_key: "{{ user `aws_access_key` }}"
  secret_key: "{{ user `aws_secret_key` }}"
  region: us-east-1
  source_ami: "{{ user `ubuntu_trusty_ami` }}"
  ami_name: bastion-host {{ isotime "2006-01-02 15:04:06" | clean_ami_name }}
  instance_type: t2.micro
  ssh_username: ubuntu
  ami_virtualization_type: hvm
  tags:
    role: bastion
  associate_public_ip_address: true
  subnet_id: "{{ user `subnet_id` }}"
  vpc_id: "{{ user `vpc_id` }}"
- type: googlecompute
  account_file: "{{ user `gce_account_file` }}"
  project_id: "{{ user `gce_project_id` }}"
  source_image: ubuntu-1404-trusty-v20160627
  zone: us-central1-b
  image_name: bastion-host-{{ timestamp }}
  machine_type: g1-small
provisioners:
- type: shell
  scripts:
  - packer-scripts/clone-travis-cookbooks
- type: chef-solo
  remote_cookbook_paths:
  - /tmp/chef-stuff/travis-cookbooks/cookbooks
  - /tmp/chef-stuff/travis-cookbooks/community-cookbooks
  json:
    duo_unix:
      integration_key: "{{ user `duo_integration_key` }}"
      secret_key: "{{ user `duo_secret_key` }}"
      api_hostname: "{{ user `duo_api_hostname` }}"
    papertrail:
      remote_port: "{{ user `papertrail_remote_port` }}"
  run_list:
  - recipe[travis_internal_bastion]
