#!/usr/bin/env bash

set -o errexit
set -o pipefail
shopt -s nullglob

main() {
  local envdir="$(dirname "${1}")"
  local relbase="$(dirname "${envdir}")"

  __load_envdir "${envdir}"

  [[ $JOB_BOARD_IMAGES_URL ]] || {
    __log 'error="missing $JOB_BOARD_IMAGES_URL"'
    exit 1
  }

  [[ $IMAGE_NAME ]] || {
    __log 'error="missing $IMAGE_NAME"'
    exit 1
  }

  local packer_env_tarball="${relbase}/packer-env-${IMAGE_NAME}.tar.bz2"
  local packer_envdir="${relbase}/packer-env-${IMAGE_NAME}"

  if [[ -f "${packer_env_tarball}" ]] ; then
    tar -C "${relbase}" -xjvf "${packer_env_tarball}"
  fi

  if [[ -d "${packer_envdir}" ]] ; then
    __load_envdir "${packer_envdir}"
  fi

  local job_board_envdir="${relbase}/job-board-${IMAGE_NAME}.env"

  if [[ -f "${job_board_envdir}" ]] ; then
    source "${job_board_envdir}"
  fi

  env | grep -E '^(PACKER|TRAVIS|TAGS|IMAGE_NAME)' | sort

  : ${TAGS:=nonempty:true}
  : ${GROUP:=$(__group)}
  : ${DIST:=$(__dist)}
  : ${OS:=$(__uname)}

  TAGS="${TAGS},os:${OS},group:${GROUP},dist:${DIST}"
  TAGS="${TAGS},packer_templates_branch:${PACKER_TEMPLATES_BRANCH}"
  TAGS="${TAGS},packer_templates_sha:${PACKER_TEMPLATES_SHA}"
  TAGS="${TAGS},travis_cookbooks_branch:${TRAVIS_COOKBOOKS_BRANCH}"
  TAGS="${TAGS},travis_cookbooks_sha:${TRAVIS_COOKBOOKS_SHA}"

  if [[ $PACKER_BUILD_NAME ]] ; then
    TAGS="$TAGS,packer_build_name:$PACKER_BUILD_NAME"
  fi

  if [[ $PACKER_BUILDER_TYPE ]] ; then
    TAGS="$TAGS,packer_builder_type:$PACKER_BUILDER_TYPE"

    case "$PACKER_BUILDER_TYPE" in
      googlecompute) IMAGE_INFRA=gce ;;
      docker) IMAGE_INFRA=docker ;;
      vmware) IMAGE_INFRA=jupiterbrain ;;
    esac
  fi

  : ${IMAGE_INFRA:=local}

  local curl_params="infra=$(__uri_esc "${IMAGE_INFRA}")"
  curl_params="${curl_params}&name=$(__uri_esc "${IMAGE_NAME}")"
  curl_params="${curl_params}&tags=$(__uri_esc "${TAGS}")"

  __log "msg=\"registering with job board\"" \
    "name=${IMAGE_NAME} infra=${IMAGE_INFRA} tags=${TAGS}"
  __log "curl_params=\"${curl_params}\""

  curl -f -s -X POST "${JOB_BOARD_IMAGES_URL}?${curl_params}" | jq .
}

__group() {
  if [[ $TRAVIS_COOKBOOKS_BRANCH = ${TRAVIS_COOKBOOKS_EDGE_BRANCH:-master} && \
    ! ${TRAVIS_COOKBOOKS_SHA:-dirty} =~ dirty && \
    $PACKER_TEMPLATES_BRANCH = master && \
    ! ${PACKER_TEMPLATES_SHA:-dirty} =~ dirty ]] ; then
    echo edge
    return
  fi
  echo dev
}

__dist() {
  lsb_release -sc 2>/dev/null || sw_vers -productVersion 2>/dev/null
}

__uname() {
  local uname_lower=$(uname | tr '[:upper:]' '[:lower:]')
  if [[ $uname_lower = darwin ]] ; then
    echo osx
    return
  fi
  echo $uname_lower
}

__uri_esc() {
  echo "\"${1}\"" | jq -r '. | @uri'
}

__log() {
  echo "time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" "$@"
}

__load_envdir() {
  for f in ${1}/* ; do
    eval "export $(basename $f)='$(cat $f)'"
  done
}

main "$@"
