#!/usr/bin/env ruby

require 'json'
require 'English'

def main
  make_request
end

def make_request
  # TODO: define these dynamically
  packer_builders = %w(amazon-ebs)
  packer_template_name = 'worker'

  body = {
    request: {
      message: ":lemon: :bomb: origin-commit=#{ENV['TRAVIS_COMMIT']}",
      branch: packer_template_name,
      config: {
        language: 'generic',
        dist: 'trusty',
        group: 'edge',
        sudo: true,
        env: {
          global: [
            'GCE_ACCOUNT_FILE=tmp/gce.json',
            "GCE_ACCOUNT_FILE_B64_BZ2=#{ENV['GCE_ACCOUNT_FILE_B64_BZ2']}",
            "GCE_PROJECT_ID=#{ENV['GCE_PROJECT_ID']}",
            "JOB_BOARD_IMAGES_URL=#{ENV['JOB_BOARD_IMAGES_URL']}"
          ],
          matrix: packer_builders.map { |b| "BUILDER=#{b}" }
        },
        install: [
          'git clone --depth=50 https://github.com/travis-ci/packer-templates.git',
          "git checkout -qf #{ENV['TRAVIS_COMMIT']}",
          'mkdir -p packer-templates/tmp',
          'echo $GCE_ACCOUNT_FILE_B64_BZ2 | base64 -d | bunzip2 > packer-templates/tmp/gce.json'
        ],
        script: [
          'cd packer-templates',
          'make',
          "make #{packer_template_name}"
        ]
      }
    }
  }

  command = [
    'curl -s -X POST',
    '-H "Content-Type: application/json"',
    '-H "Accept: application/json"',
    '-H "Travis-API-Version: 3"',
    "-H 'Authorization: token #{ENV['TRAVIS_API_TOKEN']}'",
    "-d '#{JSON.dump(body)}'",
    'https://api.travis-ci.org/repo/travis-ci%2Fpacker-build/requests'
  ]

  system command.join(' ')
end

main if $PROGRAM_NAME == __FILE__
