#!/usr/bin/env ruby

require 'json'
require 'English'

def main
  # TODO: define these dynamically
  packer_builders = %w(amazon-ebs)
  packer_template_name = 'worker'

  body = {
    request: {
      message: ":lemon: :bomb: origin-commit=#{ENV['TRAVIS_COMMIT']}",
      branch: packer_template_name,
      config: {
        language: 'generic',
        dist: 'trusty',
        group: 'edge',
        sudo: true,
        env: {
          matrix: packer_builders.map { |b| "BUILDER=#{b}" }
        },
        install: [
          'git clone --depth=50 https://github.com/travis-ci/packer-templates.git',
          "pushd packer-templates && git checkout -qf #{ENV['TRAVIS_COMMIT']} ; popd",
          './packer-templates/bin/packer-build-install'
        ],
        script: "./packer-templates/bin/packer-build-script #{packer_template_name}"
      }
    }
  }

  command = [
    'curl -s -X POST',
    '-H "Content-Type: application/json"',
    '-H "Accept: application/json"',
    '-H "Travis-API-Version: 3"',
    "-H 'Authorization: token #{ENV['TRAVIS_API_TOKEN']}'",
    "-d '#{JSON.dump(body)}'",
    'https://api.travis-ci.org/repo/travis-ci%2Fpacker-build/requests'
  ]

  `#{command.join(' ')}`
  $CHILD_STATUS.exitstatus
end

exit(main) if $PROGRAM_NAME == __FILE__
