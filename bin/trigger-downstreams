#!/usr/bin/env ruby

require 'json'
require 'English'

def main
  make_request
end

def make_request
  body = {
    request: {
      message: ":lemon: :bomb: origin-commit=#{ENV['TRAVIS_COMMIT']}",
      branch: 'ci-minimal',
      config: {
        env: {
          matrix: [
            'BUILDER=googlecompute'
          ]
        }
      },
      script: [
        'cd packer-templates',
        'make',
        'make ci-minimal'
      ]
    }
  }

  command = [
    'curl -s -X POST',
    '-H "Content-Type: application/json"',
    '-H "Accept: application/json"',
    '-H "Travis-API-Version: 3"',
    "-H 'Authorization: token #{ENV['TRAVIS_API_TOKEN']}'",
    "-d '#{JSON.dump(body)}'",
    'https://api.travis-ci.org/repo/travis-ci%2Fpacker-build/requests'
  ]

  system command.join(' ')
end

main if $PROGRAM_NAME == __FILE__
